layout: post
title: "基于CefGlue的桌面应用开发"
category: C#
tags: [c#, cef]
--- 

##前言

如果你想使用WEB技术来开发桌面客户端，并且是想使用的语言也是C#时，那请耐心往下看。使用WEB技术开发桌面客户端的核心其实就是使用一个能够独立运行WEB前端的组件，如WinForm中的WebBrowser，Android平台的WebView，以及Qt提供的WebView，等等。对于桌面客户端开发而言，使用WebBrowser空间依赖于客户端安装的IE浏览器版本，而且IE本身的种种诟病让人望而生畏。而如今，Chrome浏览器突飞猛进的发展大家有目共睹，而且其使用的核心[CEF](https://code.google.com/p/chromiumembedded/)和Webkit一样是开源的。由于Chromium是C/C++开发的，想要在C#中使用需要再次封装，一些基于Chromium的浏览器控件便应运而生。如今，市面上存在的基于Chromium的C#封装有：

<!--more-->

- [Xilium.CefGlue](https://bitbucket.org/xilium/xilium.cefglue/)
- [CefSharp](https://github.com/cefsharp/CefSharp)
- [O.N.E](http://www.one-lab.net/)
- [WebKit.NET](http://webkitdotnet.sourceforge.net/)
- [Open-Webkit-Sharp](https://code.google.com/p/open-webkit-sharp/)

关于这几个项目的优劣，[牛A与牛C之间](http://www.wuleba.com/author/flydoos)做了非常细致的比较，请参看[.NET多种WebKit内核/Blink内核浏览器初步测评报告](http://www.wuleba.com/23590.html)。最终优胜的为**Xilium.CefGlue**。此前，本作者使用过**CefSharp**，感觉很明显的优点是JS和C#之间的互调非常方便，由于本作者只是使用CefSharp开发一个小工具，所以性能和发布方面的问题暂时未碰到。

值得一提的是CEF有两个版本CEF1和CEF3。

- CEF1是单进程的。实现了更多的特性，内存使用更少，与客户端应用更能完美的结合，使用的是WebKit的API，但是FLASH无法在这个框架中正常播放，不支持html5的音频和视频，只支持NPAPI插件。关于NPAPI插件的相关知识，请参阅这里：<http://developer.chrome.com/extensions/npapi.html>。

- CEF3是多进程的。使用异步消息的方式来完成主进程和其他进程的通信（其他进程有可能是Webkit，也有可能是V8的解析引擎进程），使用的是chromium官方- 的内容呈现API，支持NPAPI和PPAPI插件，有一个单独的进程用于调试，相对于CEF1来说，虽然可以播放FLASH等视频，但是还有很多问题没有处理掉，社区里的人认为CEF1更稳定一些。

我们选用的是CEF3和Xilium.CefGlue，Xilium.CefGlue是对CEF项目的.net的包装，它是用P/Invoke的方式来调用CEF类库的，请参见：https://bitbucket.org/xilium/xilium.cefglue/wiki/Home。

下面我们就**Xilium.CefGlue**开发桌面应用中需要解决的问题逐一分析。

##运行官方Demo

####Clone或下载CefGlue

CefGlue的源码地址为 <https://bitbucket.org/xilium/xilium.cefglue/>，里边除了源码，还包含Winform和Wpf的Demo。Clone或者下载下来。

下载后，Unload或者删除其中的`CefGlue.Demo.GtkSharp`项目，这个项目是在Linux平台使用的。将`CefGlue.Demo.WinForms`设为启动项目。

####下载CEF动态链接库

CefGlue依赖的CEF的**版本支持**请参考 <http://xilium.bitbucket.org/cefglue/> 。CefGlue当前支持的CEF的最新版本为3.1650.1503，也就是当前的CEF的最新版本（不算开发分支），下载地址为 <http://cefbuilds.com/> 。

CEF同时提供Linux、Mac、Windows平台的x86、x64版本，本作者所有的实验均在Windows平台完成，使用的系统为**Windows8 x64**。如果你的机器是x64的，那么x64和x86的CEF版本均可使用。唯一的区别是，如果你使用的是x86的版本，你需要将CefGlue项目的`CefGlue.Demo.WinForms`工程属性下的`Build`选项的Platform target设置为x86，而非默认的AnyCPU。我们以x64平台为例，假设下载下来的文件件为cef_binary_3.1650.1544_windows64。

- 将`cef_binary_3.1650.1544_windows64/Release/`或者`cef_binary_3.1650.1544_windows64/Debug/`下的内容拷贝到CefGlue项目下的`CefGlue.Demo.WinForms/CefGlue.Demo.WinForms/bin/Debug/`目录下。当然，在实际项目中我们可能将这些文件拷贝到工程目录的一个文件夹中，然后使用工程属性下的Build Event选项将这些文件拷贝到Debug目录下，具体做法可以参考[怎么用CefGlue开发一个最简单的浏览器](http://www.cnblogs.com/liulun/archive/2013/05/12/3035127.html)。

- 将`cef_binary_3.1650.1544_windows64/Resources/locales`目录下的文件拷贝到`CefGlue.Demo.WinForms/CefGlue.Demo.WinForms/bin/Debug/locales`目录下。

运行即可成功，如果你有啥问题，欢迎共同探讨，或者加入QQ群244840771，群主为`牛A与牛C之间`。

**参考**

- [基于.net开发chrome核心浏览器二](http://www.cnblogs.com/liulun/archive/2013/04/20/3031502.html)
- [基于.net开发chrome核心浏览器六](http://www.cnblogs.com/liulun/p/3287028.html)

##Tutorial

- [基于.net开发chrome核心浏览器三](http://www.cnblogs.com/liulun/archive/2013/05/12/3035127.html) 怎么用CefGlue开发一个最简单的浏览器。
- [基于.net开发chrome核心浏览器四](http://www.cnblogs.com/liulun/archive/2013/05/31/3079516.html) 实现浏览器地址栏、浏览器窗口大小变化、浏览器下载文件。
- [基于.net开发chrome核心浏览器五](http://www.cnblogs.com/liulun/p/3115015.html) JsDialog的按钮错位的问题、右键菜单问题、打印的问题、打开chrome的调试器。
- [Xilium CefGlue关于CLR Object与JS 交互类库封装报告](http://www.wuleba.com/23614.html)