---
layout: post
title: "WebKit 发展史"
description: ""
category: WebKit
updated: 2014/7/16 22:12:11
author: Johnny Fee
tags: [webkit]
--- 
## 概述

WebKit是一个排版引擎，主要设计是用来让网页浏览器绘制网页。WebKit的WebCore及JavaScriptCore元件使用GNU宽通用公共许可证开源，而其他的WebKit元件则采用BSD许可证开源。

WebKit的程式码源自1998年所开发的 _KDE_ 的HTML排版引擎KHTML及KDE的JavaScript引擎KJS的程式码。接下来，KHTML及KJS透过连接器函式库（adapter library）的帮忙被移植到 OS X，并重新命名为WebCore及JavaScriptCore。

_KDE_ 是一个国际性的自由软件社区，开发运行在Linux、BSD、Solaris、Microsoft Windows 与 Mac OS X[1] 等平台上的一系列跨平台应用程序。它最著名的产品是 Plasma 桌面，是许多Linux 发布版的默认桌面环境。KDE 这个名字是来自于现有的 Common Desktop Environment (CDE) 的文字游戏，其用于 Unix 系统。__KDE 软件是基于 Qt 框架开发的__，具备了可于多数的Unix及其他类Unix系统下运行的能力， 此外还包括有Mac平台上的OS X系统和微软的Windows系统。

<!--more-->

WebKit2 发布于2010年4月8日，WebKit2的目标是将元件抽象化，并提供更干净的网页渲染，它会利用从周围的界面或是应用程式的殻，建立一个环境使网页的内容（JavaScript、HTML、排版等等）将会在另外一个程序（Process)运行，比起WebKit，这个抽象化的做法打算令WebKit2可重复使用一个更简单的程序。因为WebKit2对比起WebKit有 一个不相容的API ，所以导致他的名字被改变为WebKit2。

![](http://johnnyimages.qiniudn.com/webkit.png)

## 移植

WebKit 定义了一系列的接口，在不同的平台有不同的实现。如 [CoreGraphics](http://developer.apple.com/library/ios/#documentation/CoreGraphics/Reference/CoreGraphics_Framework/_index.html) 是Mac port的实现，而 Mac Chrome 用的是[Skia](http://www.chromium.org/developers/design-documents/graphics-and-skia)，Google创建并维护着它的Chromium port。Chromium也驱动了[Yandex Browser](http://browser.yandex.ru/)、 [360 Browser](http://se.360.cn/)、[Sogou Browser](http://ie.sogou.com/)，很快，还会有Opera。
更多请参考官方的 [WebKit Ports List]([WebKit](http://trac.webkit.org/wiki#WebKitPorts))。

下面是WebKit的5个port；尽管它们共享了WebCore的大部分，但考虑一下它们的stack有哪些不同。

&nbsp; |Chrome (OS X)| Safari (OS X)| QtWebKit| Android Browser | Chrome for iOS
-------|------------|----------------|-------------|--------------|--------
Rendering|  Skia|   CoreGraphics|  QtGui|  Android stack/Skia|  CoreGraphics
Networking|  Chromium network stack | CFNetwork|  QtNetwork|  Fork of Chromium’s network stack|   Chromium stack
Fonts|  CoreText via Skia|  CoreText|   Qt internals|   Android stack|  CoreText
JavaScript|  V8| JavaScriptCore| JSC (V8 is used elsewhere in Qt)| V8|  JavaScriptCore (without JITting) *

关于 iOS Chrome 的补充：你可能知道它使用 UIWebView。由于UIWebView的能力限制，它只能使用移动版Safari的渲染层，JavaScriptCore（而不是V8）和单进程模式。然而，大量的 Chromium 代码还是起到了调节作用 ，比如网络层、同步、书签架构、地址栏、度量工具和崩溃报告。（同时，由于JavaScript很少成为移动端的瓶颈，缺少JIT编译器只有很小的影响。）

Here is a simplified diagram that shows [the mapping](http://ariya.ofilabs.com/2011/06/your-webkit-port-is-special-just-like-every-other-port.html):

![webkit-graphicscontext.png](http://johnnyimages.qiniudn.com/webkit-graphicscontext.png)

[GraphicsContext](http://trac.webkit.org/browser/trunk/Source/WebCore/platform/graphics/GraphicsContext.h) is the interface. All other code inside WebKit will not "speak" directly to e.g. CoreGraphics on Mac. In the above rounded button example, it will call GraphicsContext’s fillRoundedRect() function.

__Live on the edge:__

参考: [Chrome Canary for Developers - Paul Irish](http://www.paulirish.com/2012/chrome-canary-for-developers/)

- Canary For Chrome
- [Mozilla Nightly](http://nightly.mozilla.org/)[updates daily](http://mozilla.- github.com/process-releases/draft/development_specifics/#versioning-firefox)
- [Opera Next](http://www.opera.com/browser/next/) updates often and you can track progress at the [Opera Desktop blog](http://my.opera.com/desktopteam/blog/).
- [WebKit Nightly](http://nightly.webkit.org/) is basically Safari nightly (it’s their video, GPU, etc stack, but without other Safari browser features)
Internet Explorer gives you platform previews, but since running the time-bombed VMs can be a pain, I run them in [BrowserStack](http://www.browserstack.com/start).

    它是WebKit的 [mac port](http://trac.webkit.org/browser/trunk/Source/WebKit/mac) ，和Safari运行的二进制文件一样（尽管会替换一些底层库）。因为苹果在项目中起主导地位，所以它的表现和功能与Safari的总是那么一致。在很多情况下，当其它port可能会试验新功能的时候，Apple却显得相对保守。不管怎样，如果你想我用中学一样的类比，想想这个好了：WebKit Nightly对于 Safari 就像 Chromium 对于 Chrome。


__What’s shared in all WebKit browsers？__

1. “ WebKit在使用相同的方式解析 HTML。” 是的，实际上，Chrome是唯一支持多线程 HTML 解析的port。
2. “一旦解析完成，会构建成相同的 DOM 树。” NO，实际上Shadow DOM只有在 Chromium Port 才被开启，所以DOM的构造也是不同的。自定义元素也是如此。
3. “ WebKit为每个人创建了 `window` 对象和 `document` 对象。” True，尽管它暴露出的属性和构造函数可以通过[feature flags](https://trac.webkit.org/wiki/FeatureFlags)来控制。
4. “CSS解析都是相同的。将CSS解析为对象模型是个相当标准的过程。” 是的，尽管 Chrome 只支持 `-webkit-` 前缀，而Apple和其他的ports支持遗留的 `-khtml-` 和 `-apple-` 前缀。
5. “布局定位？这些是基本生计问题啊。” 尽管 Sub-pixel layout(亚像素布局) 和 saturated layout（饱和布局） 算法是WebKit的一部分，不过各个port的实现效果还是有很多不同。

就像Flickr和GitHub通过flag标识来实现自己的功能一样，WebKit也有相同处理。这允许各个port自行决定是否启用[WebKit编译特性标签](https://trac.webkit.org/wiki/FeatureFlags)的各种功能。通过[命令行开关](http://peter.sh/experiments/chromium-command-line-switches/3)，或者通过[about:flags](http://blogs.adobe.com/cantrell/archives/2012/07/all-about-chrome-flags.html)还可以控制是否通过运行时标识来展示功能特性。

## 架构

- [WebKit2](http://trac.webkit.org/wiki/WebKit2) 中文 [webkit2简介.pdf](http://elastos.org/elorg_files/misc/tongji-ssec/webkit2%E7%AE%80%E4%BB%8B.pdf)

现代浏览器的组件：

* HTML、XML、CSS、JavsScript解析器
* Layout
* 文字和图形渲染
* 图像解码
* GPU交互
* 网络访问
* 硬件加速

对许多开发者来说，WebKit就像一个黑盒。我们把HTML、CSS、JS和其他一大堆东西丢进去，然后WebKit魔法般的以某种方式把一个看起来不错的网页展现给我们。但事实上，Paul的同事Ilya Grigorik说：

> WebKit才不是个黑盒。它是个白盒。并且，它是个打开的白盒。

Webkit 大体分为以下三大部分：

- WebCore 是一个由WebKit专案所开发的布局(Layout)、渲染(Rendering)及HTML和SVG的DOM函式库。
- JavaScriptCore 是一个在WebKit中提供JavaScript引擎的框架，而且在OS X作为其他内容的脚本引擎。
- Drosera 是一个JavaScript调试工具，目前已经被Web Inspector取代了。

![webkit-framework.png](http://johnnyimages.qiniudn.com/webkit-framework.png)


WebKit中的许多组件都是可以更换的（图中标灰色的部分）。

举个例子来说，Webkit的JavaScript引擎，JavaScriptCore，是WebKit的默认组件。（它最初是当WebKit从KHTML分支时从KJS演变来的）。同时，Chromium port用V8引擎做了替换，还使用了独特的DOM绑定来映射上面的组件。

## 通信

JavaScript通过IDL机制实现和内核（C/C++）之间通信，可以参考[这篇文章](http://blog.csdn.net/cutesource/article/details/8862287)。

## 原理

[How WebKit Works - Google幻灯片](https://docs.google.com/presentation/d/1ZRIQbUKw9Tf077odCh66OrrwRIVNLvI_nhLm2Gi__F0/embed?start=false#slide=id.g30f0fc55_0_40)

## 浏览器内核

主流的浏览器及其内核的对应关系如下：

浏览器         |内核          
---------------|--------------
Microsoft IE   |Trident
Mozilla Firefox|Gecko
Google Chrome  |Chromium，Blink产生之前(v27)使用WebView。
Safari         |WebKit2
Opera          |(Presto --> WebKit --> Chromium)
搜狗高速浏览器 |其最新的2.0正式版开始采用Trident/WebKit双引擎。
QQ浏览器6      |采用Trident/WebKit双引擎。
傲游浏览器     |MxWebKit1.1.3.

## Chrome

### Chromium And Chrome

Chromium 是一个由 Google 主导开发的网页浏览器，以 BSD 许可证等多重自由版权发布并开放源代码。Chromium 的开发可能早自2006年即开始，2008年12月11日发布1.0版本，设计思想基于简单、高速、稳定、安全等理念，在架构上使用了苹果发展出来的 WebKit 排版引擎（自28版起改为由WebKit所分支的 Blink 排版引擎）、Safari 的部份源代码与 Firefox 的成果，并采用 Google 独家开发出的 V8 引擎以提升解译 JavaScript 的效率，而且设计了“沙盒”、“黑名单”、“无痕浏览”等功能来实现稳定与安全的网页浏览环境。

Chromium是Google为发展自家的浏览器Google Chrome而打开的项目，所以Chromium相当于Google Chrome的工程版或称实验版（尽管Google Chrome自身也有β版阶段），新功能会率先在Chromium上实现，待验证后才会应用在Google Chrome上，故Google Chrome的功能会相对落后但较稳定。

—— [Chromium - 维基百科，自由的百科全书](http://zh.wikipedia.org/wiki/Chromium)

### Blink

Blink是一个由Google和Opera Software开发的浏览器排版引擎，Google计划将这个渲染引擎作为Chromium计划的一部分，并且在2013年4月的时候公布了这一消息。__这一渲染引擎是开源引擎WebKit中WebCore组件的一个分支__，并且在Chrome（28及往后版本）、Opera（15及往后版本）和Yandex浏览器中使用 。

—— [Blink - 维基百科，自由的百科全书](http://zh.wikipedia.org/wiki/Blink)

### V8

__V8是一个由美国 Google 开发的开源JavaScript引擎__，用于Google Chrome中。Lars Bak是这个项目的组长。

V8在运行之前将JavaScript编译成了机器码，而非字节码或是解释执行 它，以此提升性能。更进一步，使用了如内联缓存（inline caching）等方法来提高性能。有了这些功能，JavaScript程序与V8引擎的速度媲美二进制编译。

—— [V8 (JavaScript引擎) - 维基百科，自由的百科全书](http://zh.wikipedia.org/wiki/V8_(JavaScript%E5%BC%95%E6%93%8E))

### Chromium 和 WebKit 的比较

参考：[Qt将引入Qt WebEngine | Qt Chinese blog](http://blog.qt.digia.com/cn/2013/09/25/introducing-the-qt-webengine/)

以下是Qt团队通过对两者调研后得出的结论：

* Chromium关注于跨平台建设，其浏览器能够运行在所有主流桌面平台和Android上；与此同时，WebKit则不那么专注。我们自己的项目则必须支持所有的OS平台。
* Chromium中对很多事情都提供了支持，在WebKit下同样支持这些东西则需要耗费大量精力。例如，我们可以简单地重用平台/OS的适配代码。多媒体以及如WebRTC这样的新HTML5特性，都是直接可用的，无需特别的Qt代码。
* 使用Chromium可以简化OS集成工作，这使得我们可以有更多精力关注于更高层面，提供一个可以无缝集成于Qt之中并且简单而强大的API。
* 我们注意到Chromium的开发处于代码质量的严格控制之中。这简化了我们的测试工作，有利于提供更稳定和高质量的Web引擎。
* 比起WebKit，Chromium允许我们构建更好更高效的组件和Qt Quick scene graph。

所以，“我们将在Chromium基础之上建立未来的Web引擎——Qt WebEngine。”——Qt研发团队。

## 性能测试

- http://dromaeo.com/
	- [wiki](https://wiki.mozilla.org/Dromaeo)
- [SunSpider 1.0.2 JavaScript Benchmark](https://www.webkit.org/perf/sunspider/sunspider.html)

## Tutorial

- [WebKit](https://trac.webkit.org/wiki)

## Books

- [The Browser Hacker’s Handbook](http://www.salttiger.com/the-browser-hackers-handbook/)

## 参考

- [Yongsheng关于WebKit的系列文章](http://blog.csdn.net/milado_nju/article/category/1060499)
- [Blink: Chromium的新渲染引擎](http://blog.csdn.net/doon/article/details/9253453)
- [WebKit - 维基百科，自由的百科全书](http://zh.wikipedia.org/wiki/WebKit)
- [WebKit for Developers - Paul Irish](http://www.paulirish.com/2013/webkit-for-developers/)
    + [开发者需要了解的WebKit](http://www.infoq.com/cn/articles/webkit-for-developers)
