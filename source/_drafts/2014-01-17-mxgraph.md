---
layout: post
title: "mxGraph学习"
category: android
tags: [android,hack]
--- 

##创建Graph对象

	// 检查浏览器是否支持
	// Checks if browser is supported
	if (!mxClient.isBrowserSupported()){
		// Displays an error message if the browser is
		// not supported.
		mxUtils.error('Browser is not supported!', 200, false);
		return;
	}

	// 获取一个div作为Graph的容器
	var container = document.getElementById('id-of-graph-container');

	// 兼容IE
	// Workaround for Internet Explorer ignoring certain styles
	if (mxClient.IS_IE){
		new mxDivResizer(container);
	}

	// 初始化mxGraph对象
	var graph = new mxGraph(container);

##mxGraph常用设置

以下设置项的参数均为默认值。

	// Cell大小是否可变。false时Cell周长上的拉伸点不可见。
	graph.setCellsResizable(true);
	
	// Cell是否可以移动。
	mxGraphHandler.prototype.setMoveEnabled(true);

	// 移动或者创建Cell时，是否显示标尺。
	// 可以通过graph.gridSize = 30 调整单元格大小。
	mxGraphHandler.prototype.guidesEnabled = false; 

	//是否只读。
	graph.setEnabled(true);

	// cell是否可以连线。
	// false时所有Cell的中心连接点（通过拖拽该点可以创建连接线）不可见。
	graph.setConnectable(true);

	//Cell是否锁定。true时表示有点顶点（图形）不可移动，所有边（连接线）不可移动，不可重新连接到其他顶点（图形）。
	graph.setCellsLocked(false);

	//Cell是否解析html。如设置Cell的name为`<b>Stronger</b>`，即可加粗Cell的文本。
	graph.setHtmlLabels(true);

	// 是否允许平移。true：表示按住Shift+左键拖动时，整个graph移动；
	// false：按住Shift+左键拖动时，选中的图形水平方向或者垂直方向平移。
	graph.setPanning(true);

	// 是否启用工具提示信息。
	graph.setTooltips(false);

	// 从一个图形的中心连接点拖拽出连接线时，是否复制该图形。
	graph.connectionHandler.createTarget = false;

	// 连线上的Label是否可以移动。
	graph.edgeLabelsMovable = true;

	// 当鼠标滑动到Cell时，高亮显示。
	new mxCellTracker(graph);

##禁用Cell双击，防止改变数据

	graph.dblClick = function (evt, cell) {
		var model = graph.getModel();
		if (model.isVertex(cell)) {
			return false;
		}
	};

##获得Graph的根Cell

	// Gets the default parent for inserting new cells. This
	// is normally the first child of the root (ie. layer 0).
	var parent = graph.getDefaultParent();

##绘制图形

使用insertVertex和insertEdge方法来插入点和边。

insertVertex的参数说明如下：

 * parent - `<mxCell>` that specifies the parent of the new vertex.
 * id - Optional string that defines the Id of the new vertex.
 * value - Object to be used as the user object.
 * x - Integer that defines the x coordinate of the vertex.
 * y - Integer that defines the y coordinate of the vertex.
 * width - Integer that defines the width of the vertex.
 * height - Integer that defines the height of the vertex.
 * style - Optional string that defines the cell style.
 * relative - Optional boolean that specifies if the geometry is relative. Default is false.

insertEdge的参数说明如下：

 * parent - `<mxCell>` that specifies the parent of the new edge.
 * id - Optional string that defines the Id of the new edge.
 * value - JavaScript object to be used as the user object.
 * source - `<mxCell>` that defines the source of the edge.
 * target - `<mxCell>` that defines the target of the edge.
 * style - Optional string that defines the cell style.


如使用代码插入两个长方形和一条连接线的代码如下：

	var parent = graph.getDefaultParent();
	
	// Adds cells to the model in a single step
	graph.getModel().beginUpdate();
	try
	{
		var v1 = graph.insertVertex(parent, null, 'Hello', 20, 20, 80, 30);
		var v2 = graph.insertVertex(parent, null, 'World', 200, 150, 120, 30);
		var e1 = graph.insertEdge(parent, null, 'HelloWorld', v1, v2);
	}
	finally
	{
		// Updates the display
		graph.getModel().endUpdate();
	}

对应的xml大致为：

	<mxGraphModel>
	  <root>
	    <mxCell id="0"/>
	    <mxCell id="1" parent="0"/>
	    <mxCell id="2" value="Hello," style="rounded=1" vertex="1" parent="1">
	      <mxGeometry x="20" y="20" width="80" height="30" as="geometry"/>
	    </mxCell>
	    <mxCell id="3" value="World!" style="rounded=1" vertex="1" parent="1">
	      <mxGeometry x="200" y="150" width="120" height="30" as="geometry"/>
	    </mxCell>
	    <mxCell id="4" value="HelloWorld" edge="1" parent="1" source="2" target="3">
	      <mxGeometry relative="1" as="geometry"/>
	    </mxCell>
	  </root>
	</mxGraphModel>

效果如下：

![Hello World](http://johnnyimages.qiniudn.com/graph-hello-world.png)

##常用操作

- 按住Ctrl拖拽图形即可完成复制。
- 按住Shift拖拽可将Graph整体移动。

##禁用右键上下文菜单

	// Disables built-in context menu
	mxEvent.disableContextMenu(container);

##自动处理平行线

默认情况下，添加两条以上有向平行线时，这些平行线会堆叠在一起。使用以下方法可以将这些平行线错开。

	// Automatically handle parallel edges
	var layout = new mxParallelEdgeLayout(graph);
	var layoutMgr = new mxLayoutManager(graph);

	layoutMgr.getLayout = function(cell)
	{
		if (cell.getChildCount() > 0)
		{
			return layout;
		}
	};

##修改连接线默认的配置

	var style = graph.getStylesheet().getDefaultEdgeStyle();
	// 连接线的拐弯处使用圆角，默认为直角。
	style[mxConstants.STYLE_ROUNDED] = true;
	// 使用弯曲连接线，默认为直线。
	style[mxConstants.STYLE_EDGE] = mxEdgeStyle.ElbowConnector;

	// 默认的连接线为水平连接，双击该连接线的主控点（连接线中间的关键点）时变为垂直连接。只有连接线为弯曲线时才有效。
	graph.alternateEdgeStyle = 'elbow=vertical';

默认情况，使用直线连接：

![直线连接](http://johnnyimages.qiniudn.com/straight.png)

曲线圆角连接：

![曲线圆角连接](http://johnnyimages.qiniudn.com/elbow-round.png)

双击连接线主控点后，变为：

![双击连接线主控点](http://johnnyimages.qiniudn.com/alternate.png)

##为Cell（单元）添加自定义提示

	// Installs a custom tooltip for cells
	graph.getTooltipForCell = function(cell)
	{
		return 'Doubleclick and right- or shiftclick';
	}

将光标停留在Cell，包括所有点和边，均出现自定义提示，`Doubleclick and right- or shiftclick`。

##自定义*创建连接点*的图片

![自定义新连接的图片](http://johnnyimages.qiniudn.com/new-connection.png)

	// Sets the image to be used for creating new connections
	mxConnectionHandler.prototype.connectImage = new mxImage('images/green-dot.gif', 14, 14);

##启用框选

	var rubberband = new mxRubberband(graph);

##为Cell添加弹出式菜单

弹出式菜单可以通过**右键**或者**Shirt+左键**触发：


	// Installs a popupmenu handler using local function (see below).
	graph.panningHandler.factoryMethod = function(menu, cell, evt)
	{
		return createPopupMenu(graph, menu, cell, evt);
	};
	
createPopupMenu定义：

	// Function to create the entries in the popupmenu
	function createPopupMenu(graph, menu, cell, evt)
	{
		if (cell != null)
		{
			menu.addItem('Cell Item', 'editors/images/image.gif', function()
			{
				mxUtils.alert('MenuItem1');
			});
		}
		else
		{
			menu.addItem('No-Cell Item', 'editors/images/image.gif', function()
			{
				mxUtils.alert('MenuItem2');
			});
		}
		menu.addSeparator();
		menu.addItem('MenuItem3', '../src/images/warning.gif', function()
		{
			mxUtils.alert('MenuItem3: '+graph.getSelectionCount()+' selected');
		});
	};
	

##启用按键处理

TODO

##动态改变Cell的样式

###启用updateStyle

	// Needs to set a flag to check for dynamic style changes, that is, changes to styles on cells where the style was not explicitely changed using mxStyleChange.
	// 意思是，当启用了updateStyle时，cell发生变化时，其样式也会动态地发生变化。

	graph.getView().updateStyle = true;

###覆盖getStyle

	graph.model.getStyle = function(cell){
		if (cell != null)
		{
			// 调用被覆盖的函数
			var style = previous.apply(this, arguments);

			// 设置连线的样式
			if (this.isEdge(cell))
			{
				var target = this.getTerminal(cell, false);

				if (target != null)
				{
					// 将连线的strokeColor设置为目标的fillColor
					var state = graph.getView().getState(target);
					var targetStyle = (state != null) ? state.style : graph.getCellStyle(target);
					var fill = mxUtils.getValue(targetStyle, mxConstants.STYLE_FILLCOLOR);
					
					if (fill != null)
					{
						style += ';strokeColor='+fill;
					}
				}
			}
			else if (this.isVertex(cell))
			{
				// 当顶点图形的width>80时，将填充颜色编程绿色。
				var geometry = this.getGeometry(cell);
				
				if (geometry != null &&
					geometry.width > 80)
				{
					style += ';fillColor=green';
				}
			}
			
			return style;
		}
		
		return null;
	};

参考examples/dynamicstyle.html。

###常用样式

- mxConstants.STYLE_SHAPE: 'shape' 形状，可用形状可以参考源码文件mxConstants.js中以SHAPE_开头的常量。
- STYLE_PERIMETER: 'perimeter' 定义周长的样式。值可以为mxPerimeter.js中PERIMETER_开头的常量或者mxConstants.js中PERIMETER_开头的常量，不过必须保证这正字符串在mxStyleRegistry.js以被注册。该样式的具体用法还待确认。
- STYLE_GRADIENTCOLOR: 'gradientColor' 渐变颜色
- STYLE_PERIMETER_SPACING: 'perimeterSpacing' 周长外边距。有点像CSS中的Margin属性，可以理解与其他Cell的安全距离，其他Cell只能接触到安全距离，而无法到达安全距离之内。
- STYLE_SHADOW: 'shadow',是否使用阴影。
- strokeWidth 边距，即border-width。
- labelBackgroundColor Label的背景色。
- fontStyle 字体。

其他样式可查看源码文件mxConstants.js中STYLE_开头的常量。

	var e1 = graph.insertEdge(parent, null, 'Connect', v1, v2, 'perimeterSpacing=4;strokeWidth=4;labelBackgroundColor=white;fontStyle=1');

##mxUtils
错误提示：

	mxUtils.error('Browser is not supported!', 200, false);

