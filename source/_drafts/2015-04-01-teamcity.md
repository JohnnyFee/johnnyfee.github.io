layout: post
title: "TeamCity Tutorial"
category : TeamCity
tags : [teamcity, team]
---

## 安装配置

1. 下载 <http://www.jetbrains.com/teamcity/download/index.html>
2. 安装

    安装时可修改端口号，也可以在TEAMCITY_HOME/conf/server.xml中修改。

        <Connector port="8083" protocol="HTTP/1.1"
                     connectionTimeout="60000"
                     redirectPort="8543"
                     useBodyEncodingForURI="true"
        />

    设置Git环境变量 `TEAMCITY_GIT_PATH =C:\Git\bin`

3. 存储到数据库

    TeamCity默认使用内存数据库。

4. 备份

    __通过网页备份Administration/Backup__

    备份路径默认为%TEAMCITY_DATA_PATH%/backup。

    可以通过修改%TEAMCITY_DATA_PATH%/config/backup-config.

    xml中path属性来自定义备份路径：

        <general>
            <backup-dir path="backup" />
        </general>

    __通过命令备份（备份前需要停止服务）__

    maintainDB backup，备份路径同上，修改制定命令参数修改备份参数，如范围、备份路径等。如：
    
        maintainDB backup -C -D -L –P
    
    制作一个scope=all except build artifacts的备份。

5. 还原

使用 _maintainDB restore_ 命令，默认使用%TEAMCITY_DATA_PATH%/backup下的备份文件备份，可以通过-A来指定TEAMCITY_DATA_PATH，可以使用-T指定目标数据库，从而实现不同数据库之前的还原，如把HSQL还原到MYSQL数据库中。

6. 常用命令

        runAll.bat start/启动服务和默认代理
        runAll.bat stop/关闭服务和默认代理

7. 权限

    配置验证方案
        
        %TEAMCITY_DATA_PATH%/config/main-config.xml 下的 `<auth-type>` 节点。
    
        详见 <http://confluence.jetbrains.net/display/TCD7/Configuring+Authentication+Settings>

8. 配置邮件通知

    _Administration/Email Notifier_

    以Gmail为例：

    ![](http://johnnyimages.qiniudn.com/teamcity-gmail.png)

9. 代理

    用来自行构建的服务器。一个代理只能可以属于一个代理池，一个项目可以使用多个代理池来执行构建。
 
## 单元测试

常用的框架有Nunit、xUnit、MSTest。

### Nunit

- 官网：http://nunit.org/index.php?p=home
- 通过VS下载扩展持续“NUnit Test Adapter”以便可以在vs中运行Nunit测试类。
- 新建测试工程，通过Nuget导入nunit依赖。
- 编写测试类，右键执行测试

## 代码覆盖（dotCover）

- 下载http://www.jetbrains.com/dotcover/documentation/index.jsp
- 设置启用Unit Testing
- 通过单元测试计算代码覆盖率

## 持续集成

1. 构建

    新建项目 _Administration/Projects/Create Project_

1. 新建构建配置

    在创建的项目下点击“Create build configuration”按钮，在“General Settings”下添加Name属性，其他采用默认配置。

1. 配置VCS

    点击“VCS settings”/点击“Create and attach new VCS root”，创建VCS库，以Git为例。

    以下为必填项，其他采用默认配置。

    ![](http://johnnyimages.qiniudn.com/teamcity-vcs.png)

    ![](http://johnnyimages.qiniudn.com/teamcity-general-setting.png)

    根据验证模式配置

    ![](http://johnnyimages.qiniudn.com/teamcity-validate.png)

    点击“Add Build Step”

1. MSBuild（编译）

    ![](http://johnnyimages.qiniudn.com/teamcity-msbuild.png)

1. NUnit（测试）
    
    也可以使用MSTest，对于既有MSTest和NUnit测试用例的工程，可以添加两个构建步骤，一个使用MSTes，一个使用NUnit。
    
     ![](http://johnnyimages.qiniudn.com/teamcity-buildstep.png)

    点击 “Add build step”，配置NUnit

    

1. 添加构建触发器
    
    选择工程/Edit Project Settings/“ConsoleApplication1Build”/Configuration Steps下的Build Triggers/Add Trigger/
    
    以VCSTrigger为例

    ![](http://johnnyimages.qiniudn.com/teamcity-covary.png)
    
    采用默认配置参数，当TeamCity做一次check out之后，会自动触发一次构建。

1. 配置代码覆盖

    导航到“Configuration Steps”，方法同上，选择Build Steps，修改Test Step（MSTest或者Nunit），修改.NET Coverage参数：

    其中+：即需要统计统计的构建，-=为禁止统计的构建。
    
    查看统计结果：

    ![](http://johnnyimages.qiniudn.com/teamcity-covarage-config.png)
    
    See [Coverage with TeamCity and dotCover with MSTest, NUnit or MSpec](http://blogs.jetbrains.com/dotnet/2010/12/coverage-with-dotcover-teamcity-mstest-nunit-or-mspec/)

### 打包

### 发布