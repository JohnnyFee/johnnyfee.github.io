layout: post
title: "Maven Tutorial"
description: ""
category: Maven
tags: [maven]
---
##	安装

[下载Maven](http://maven.apache.org/download.cgi)

**设置环境变量**

- M2_HOME=maven根目录
- 添加Path %M2_HOME%\bin
- 可以添加MAVEN_OPTS=-Xms128m -Xmx512m设置JDK内存使用情况
- 将%MAVEN_HOME%/conf/settings.xml拷贝到%USERPROFILE%/.m2下，并定期备份，以便升级和重装时不会覆盖配置

**安装m2eclipse插件**

- 配置Eclipse使用指定版本的Maven Windows/Preferences/Installations/选择External...
- 通过Eclipse Supermarket安装
[官方网站](http://m2eclipse.sonatype.org/sites/m2e)|
[其他相关插件site](http://m2eclipse.sonatype.org/sites/m2e-extras)

**创建Maven工程**
:	根据对Maven源码结构的分析，一个项目通常包括N+1个Maven工程。其中N为模块个数，每个工程的名字为模块名，命名规则为项目名-模块名，如maven-core；1为聚合工程，即父工程，通常为项目的名称如maven。


<!--more-->
 
##	Maven

###Maven常用指令(在项目根目录下执行)

- clean 清除编译的内容，删除target文件夹。
- compile 编译源码，不包括测试代码
- package 根据打包类型打包
- install 将项目输出如jar安装到本地仓库
- archetype:generate 选择骨架类型，从而声称相应的骨架。

坐标
:	
- groupId：项目名称，如com.nexus
- artifactId：项目模块名称，如nenux-indexer，命名规则通常是“项目名-模块名”
- version：版本，如2.0.0、SNAPSHOT
- packaging：打包方式，如jar、war，默认为jar
- classfier：附属构建，不能直接定义

##依赖
依赖范围
:	compile/编译、测试、运行均有效（默认），test/编译、测试，runtime/测试、运行，provided/编译、测试，system/同provided（不使用），import/合并依赖构建的dependencyManage。

传递性
:	P56。可选依赖（`<optional>true <optional/>`）都不会被传递，需要在POM中声明，用于解决类型针对同一项目中可选依赖不同驱动的问题。

依赖调解
:	路径最短优先、路径相同时，使用第一声明者优先。

排除依赖
:	排除某个被传递进来的依赖，用于修改传递依赖的版本，与法见P69。

归类依赖
:	使用properties声明版本变量，在同一个项目的不同模块中引用相同的版本，用于依赖类型spring的各个模块（通常模块的版本时相同的），P70代码清单5-12。

优化依赖
:	dependency:list/查看依赖列表；dependency:tree/查看依赖树形结构；dependency:analyze/分析依赖，可以根据结果进行优化。

##仓库
本地仓库
:	默认路径为%userprofile%/.m2/repository。可以通过修改.m2/settings.xml来更改路径，修改`<localRepositoty>`的值。当依赖某个构件时，先从本地仓库查找，如未找到，再从远程仓库查找。

远处仓库
:	包括私服、中央仓库等。中央仓库的默认地址为http://repo1.maven.org/maven2。配置远程仓库见P82，代码6-2。

镜像
:	可以用于私服配置，用私服仓库作为所有远程仓库的镜像，开发人员只需配置私服仓库即可。配置如P39 6-8。
搜索：https://repository.sonatype.org

**推荐使用镜像：**

  	<mirror>
      <id>ibiblio</id>
      <mirrorOf>central</mirrorOf>
      <name>ibiblio</name>
      <url>http://mirrors.ibiblio.org/maven2/</url>
    </mirror>

##生命周期
clean
:	pre-clean、clean、post-clean

default
:	validate、generate-sources、compile、test-compile、package、install、deploy

site
:	pre-ste、site（生成项目文档）、post-site、site-deploy（讲生成的项目站点发布到服务器上）
用命令行执行时，会执行所在生命周期上的对应阶段之前的所有阶段。如mvn clean deploy会执行clean生命周期的pre-clean、clean，和default阶段的所有阶段。

##插件
开启对Java5的支持（使用Java5编译、编译成Java5的目标代码）

	<plugin>
	    <groupId>org.apache.maven.plugins</groupId>
	    <artifactId>maven-compile-plugin</artifactId>
	    <configuration>
	        <srouce>1.5</srouce>
	        <target>1.5</target>
	    </configuration>
	</plugin>


可以项目级别pom.xml和全局设置settings.xml。
- 配置可运行的jar，P35。
- 配置生成源码插件目标绑定P102 7-3。
- 搜索网址：
	http://maven.apache.org/plugins/index.html
	http://mojo.codehaus.org/plugins.html

mvn help
:	mvn help –Dplugin=compile/获取插件的帮助
	mvn –h查看mvn命令格式

聚合和继承
:	子模块可以继承父模块（项目）中的pom配置，通常子项目中不再显示声明groupId和version，从父模块中继承，而只需要显示声明子模块的artifactId。 在子模块中声明父模块的代码如下：

	<parent>
	  <groupId>org.apache.maven</groupId>
	  <artifactId>maven</artifactId>
	  <version>3.1-SNAPSHOT</version>
	</parent>

其中省略了`<relativePath>`，其默认值../pom.xml，如果在上级目录中没有父模块的pom，则需要通过`<relativePath>`声明pom的相对路径。

聚合
:	将各个模块聚合起来，如

	<modules>
	<module>architect-core</module>
	</modules>

父模块的packaging类型必须是pom。modules包括所有的子模块和父模块（N +1）。
注：修改模块的打包类型之后，需要更新项目的配置，右击项目/Maven/Update Project Configuration。

继承
:	继承父模块中的pom配置。
通常通过`<dependencyManagement>`在父模块中声明依赖，该依赖声明不会引入实际的依赖，这样可以避免每个子模块加载不必要的依赖。当子模块需要使用父模块中声明的依赖时，只需要在子模块的dependenty中通过groupId和artifactId来声明，其他属性可以从父模块的配置中继承。

可以在父模块中声明pluginManagement申明插件，原理同依赖。

反应堆
:	模块的总和，即moduels中的内容。构建时，默认情况下打包所有的子模块。可以通过命令：

	mvn clean install –pl account–email, account-persist来指定构建的模块
	mvn clean install –pl account-email –am 构建指定模块所依赖的模块（account-parent）
	mvn clean install –pl account-parent –amd 构建依赖指定模块的所有模块（account-email等）

	其他裁剪请参考P146。

## 私服

作为企业的仓库服务器，可以减少客户端配置，加快访问速度等。
Apache的Archiva，JFrog的Artifactory和Sonatype的Nexus。

###安装
**下载**
http://www.sonatype.org/nexus/
	
###常用命令：
- 从命令行启动/nexus console
- 安装服务/nexus install
- 启动服务/nexus start 
- 重启服务/nexus restart
- 停止服务/nexus stop

访问站点http://localhost:8081/nexus/index.html#welcome
超级管理员：admin/admin123

###仓库
代理仓库（proxy）
:	如Central、Google Code、Codehaus等

宿主（hosted）
:	用来存放公司安装的构建，供其他项目使用。分为Release版和Snapshorts两个仓库，分别用于存放发布版本和快照版本。

第三方仓库（3rd party）
:	用来存放如Oracle Jdbc在仓库中找不到，需要从第三方公司下载的构建。

仓库组
:	可用仓库的有序组合，查找构建时按照顺序查找。


配置文件中repository和pluginrepository的区别：

> Technical no. It's for having different configurations-\>behavior for plugins in contrary to normal artifacts. For example you want to use different update policy or you want no SNAPSHOT plugins.

参考[Maven terms — dependency and plugin, repository vs. pluginRepository](http://stackoverflow.com/questions/12044909/maven-terms-dependency-and-plugin-repository-vs-pluginrepository/12045065#12045065)

###索引
需要下载远程仓库的索引才能执行搜索。下载索引需要一定的时间，可以在“Scheduled Tasks”中查看当前任务的状态。
 
###使用私服
	在settings.xml中配置添“私服”为远程服务器，使用`<profile>`， 并且设置仓库的id为central，覆盖超类的仓库id，使“私服”成为构建下载的唯一服务器。

	<repository>
		<id>central</id>
		<name>Nexus</name>
		<url>http://localhost:8081/nexus/content/groups/public/</url>
		<release>
			<enable>true</enable>
		</release>
		<snapshots>
			<enable>true</enable>
		</snapshots>
	</repository>

其中url的地址无所谓，因为下一步会将所有的仓库转为nuxus私服代理。插件的配置与此类似。

为所有仓库添加镜像，镜像地址为nexus public仓库地址，使对所有仓库的请求都转为对nexus私服的请求。

	<mirror>
	<id>nexus</id>
	<mirrorOf>*</mirrorOf>
	<url>http://localhost:8081/nexus/content/groups/public/</url>
	</mirror>

**发布**
在POM中配置发布仓库

	<distributionManagement>
		<repository>
			<id>nexus-releases</id>
			<name>Nexus Releases Repository</name>
			<url>http://localhost:8081/nexus/content/repositories/releases/</url>
		</repository>
		<snapshotRepository>
			<id>nexus-snapshots</id>
			<name>Nexus Releases Repository</name>
			<url>http://localhost:8081/nexus/content/repositories/snapshots/</url>
		</snapshotRepository>
	</distributionManagement>

在settings.xml中配置验证信息

	<servers>
		<server>
			<id>nexus-releases</id>
			<username>admin</username>
			<password>admin123</password>
		</server>
		<server>
			<id>nexus-snapshots</id>
			<username>admin</username>
			<password>123</password>
		</server>
	</servers>

如果是快照版本，需要在版本后加上-SNAPSHOT，发布时会自动发布到nexussnapshorts仓库。
可以访问http://localhost:8081/nexus/content/repositories/releases/查看发布版本；http://localhost:8081/nexus/content/repositories/snapshots/查看快照版本；也可以从http://localhost:8081/nexus/index.html查看相关仓库中的发布。

###权限控制

默认用户admin/admin123、deployment/deployment123、anonymous
为项目创建仓库`Repositories/Add`
`<TODO>` 图片
其中，repositoryId的命名规则和Maven项目的命名规则一样，单词全部小些，用-分隔，设置Repository Name，设置Deployment Policy为Allow Redeploy，选择Repository Type（Releases或者Snapshorts），其他使用默认。

**创建权限（增删改查）**
Privilege/Ad/输入Name、Description、选择Repository、选择Repository Target（Maven2），保存后即生成相关项目（S960 Releases）的增删改查权限。
	添加角色
Role/Add
 
**将权限分配给相关用户**

###调度任务
Administration/Scheduled Tasks，各调度任务的说明见P170。
 
##测试
### 常用命令
	mvn packae –DskipTests/跳过测试
	mvn package –Dmaven.test.skip=true/跳过本次测试的编译和运行
	mvn test –Dtest = RandomGenratorTest/只有RandomGeneratorTest被执行，可以通过“,”指定多个类，也可以使用通配符*。

###	重用测试代码
有时需要将测试代码工具包打包，在不同项目的测试工程中引用，并且不被主工程引用。
配置test-jar目标：

	<plugin>
	    <groupId>org.apache.maven.plugins</groupId>
	    <artifactId>maven-jar-plugin</artifactId>
	    <version>2.2</version>
	    <executions>
	        <execution>
	            <goals>
	                <goal>test-jar</goal>
	            </goals>
	        </execution>
	    </executions>
	</plugin>

配置后打包时，会生成两个构建，一个普通构建，一个以tests结尾的构建。
依赖测试包构建，跟以来普通构建一样，只是type需要设置成test-jar，scope设置为test。

###过滤测试类
可以通过配置org.apache.maven.plugins：maven-surefire-plugin的includes和excludes属性来包含和排除测试类。

###测试报告
运行测试之后再target/surefire-reports中查看测试报告，测试报告提供两种形式，简单文本格式和JUnit兼容的XML格式，可以使用JUnit视图打开改XML。

###测试覆盖率

	mvn cobertura:cobertura

在target/site/cobertura目录下查看报告。

##持续集成
###安装

官网：http://hudson-ci.org/
下载地址：http://eclipse.org/downloads/download.php?file=/hudson/war/hudson-3.0.0.war

**运行**
	java -jar hudson-3.0.0.war [--httpPort=8082]
	
访问网址http://localhost:8080/

首次运行需要选择更新和插件/安装。
配置JDK和Maven路径，一般不采用自动安装。

###资源
http://www.eclipse.org/hudson/the-hudson-book/book-hudson.pdf

注：本文章中的引用页数指的均为《Maven实战-许晓斌》一书。


